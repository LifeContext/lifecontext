name: Code Quality

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Extension/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Extension/**'

jobs:
  # Backend Code Quality
  backend-quality:
    name: Backend Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pylint black isort
      
      - name: Check code formatting with Black
        working-directory: ./backend
        run: black --check --diff . || echo "‚ö†Ô∏è  Some files need formatting"
        continue-on-error: true
      
      - name: Check import sorting with isort
        working-directory: ./backend
        run: isort --check-only --diff . || echo "‚ö†Ô∏è  Some imports need sorting"
        continue-on-error: true
      
      - name: Run pylint
        working-directory: ./backend
        run: |
          pylint routes/ utils/ tools/ app.py --disable=all --enable=E,F 2>/dev/null || echo "‚ö†Ô∏è  Pylint warnings found"
        continue-on-error: true
      
      - name: Generate flake8 report
        working-directory: ./backend
        run: |
          flake8 . --format=html --htmldir=flake8-report 2>/dev/null || true
        continue-on-error: true

  # Frontend Code Quality
  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Check TypeScript types
        working-directory: ./frontend
        run: npx tsc --noEmit
        continue-on-error: true
      
      - name: Install ESLint (if not present)
        working-directory: ./frontend
        run: npm install --save-dev eslint 2>/dev/null || true
        continue-on-error: true
      
      - name: Run ESLint
        working-directory: ./frontend
        run: npx eslint . --ext .ts,.tsx,.vue --max-warnings 10 2>/dev/null || echo "‚ö†Ô∏è  ESLint issues found"
        continue-on-error: true
      
      - name: Check for console logs
        working-directory: ./frontend
        run: |
          echo "Checking for debug console logs..."
          grep -r "console\." src/ --include="*.ts" --include="*.tsx" --include="*.vue" --include="*.js" | \
            grep -v "console\.error\|console\.warn" || echo "‚úì No debug console logs found"
        continue-on-error: true

  # Extension Code Quality
  extension-quality:
    name: Extension Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'Extension/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./Extension
        run: npm ci
      
      - name: Install ESLint (if not present)
        working-directory: ./Extension
        run: npm install --save-dev eslint 2>/dev/null || true
        continue-on-error: true
      
      - name: Run ESLint
        working-directory: ./Extension
        run: npx eslint . --ext .js --max-warnings 10 2>/dev/null || echo "‚ö†Ô∏è  ESLint issues found"
        continue-on-error: true
      
      - name: Check manifest and file structure
        working-directory: ./Extension
        run: |
          echo "Checking Extension structure..."
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          const requiredFiles = [
            'extension/manifest.json',
            'extension/background.js',
            'extension/content.js',
            'server.js',
            'package.json'
          ];
          
          let allExist = true;
          requiredFiles.forEach(file => {
            if (fs.existsSync(file)) {
              console.log('‚úì', file);
            } else {
              console.error('‚úó', file, '(MISSING)');
              allExist = false;
            }
          });
          
          if (!allExist) {
            process.exit(1);
          }
          "
      
      - name: Check for security issues
        working-directory: ./Extension/extension
        run: |
          echo "Checking for potential security issues..."
          
          # Check for eval usage
          if grep -r "eval(" *.js 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: eval() found - potential security risk"
          else
            echo "‚úì No eval() usage found"
          fi
          
          # Check for hardcoded URLs
          if grep -r "http://" *.js | grep -v "localhost" 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: Non-localhost HTTP URLs found"
          else
            echo "‚úì No hardcoded HTTP URLs found"
          fi
        continue-on-error: true

  # Summary
  quality-summary:
    name: Quality Check Summary
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality, extension-quality]
    if: always()
    
    steps:
      - name: Report
        run: |
          echo "=========================================="
          echo "     Code Quality Check Summary"
          echo "=========================================="
          echo "Backend Quality:   ${{ needs.backend-quality.result }}"
          echo "Frontend Quality:  ${{ needs.frontend-quality.result }}"
          echo "Extension Quality: ${{ needs.extension-quality.result }}"
          echo "=========================================="
          echo ""
          echo "üìù Note: Quality checks are informational."
          echo "   Failures don't block PR merges."

